---
title: "社会的選好パラメータの推定分析"
author: "AI学会2025"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: united
    highlight: tango
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
# 基本設定
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  out.width = "100%"
)

# 必要なパッケージの読み込み
library(tidyverse)
library(maxLik)
```

# データの準備と前処理

```{r data_preparation}
# データの読み込みと確認
# AI条件のデータ
data_0117_3 <- read_csv("AI2025_data/20250117_3/dictator_app_2025-01-17.csv")
data_0120_5 <- read_csv("AI2025_data/20250120_5/dictator_app_2025-01-20.csv")

# コントロール条件のデータ
data_0117_4 <- read_csv("AI2025_data/20250117_4/Base_dictator_app_2025-01-17.csv")
data_0120_4 <- read_csv("AI2025_data/20250120_4/Base_dictator_app_2025-01-20.csv")

# データの構造確認
glimpse(data_0117_3)

# 重要な変数の確認
summary_vars <- data_0117_3 %>%
  filter(participant.visited == 1) %>%
  select(
    player.choice,
    player.payoff_dictator,
    player.payoff_receiver,
    subsession.round_number
  )
summary(summary_vars)

# データのクリーニング
# AI条件
data_0117_3_clean <- data_0117_3 %>%
  filter(participant.visited == 1) %>%
  mutate(condition = "AI", date = "2025-01-17")

data_0120_5_clean <- data_0120_5 %>%
  filter(participant.visited == 1) %>%
  mutate(condition = "AI", date = "2025-01-20")

# コントロール条件（ラウンド16を除外）
data_0117_4_clean <- data_0117_4 %>%
  filter(participant.visited == 1) %>%
  filter(subsession.round_number != 16) %>%
  mutate(condition = "Control", date = "2025-01-17")

data_0120_4_clean <- data_0120_4 %>%
  filter(participant.visited == 1) %>%
  filter(subsession.round_number != 16) %>%
  mutate(condition = "Control", date = "2025-01-20")

# データの結合
raw_data <- bind_rows(
  data_0117_3_clean,
  data_0120_5_clean,
  data_0117_4_clean,
  data_0120_4_clean
)

# データ前処理関数の定義
prepare_social_preference_data <- function(data) {
  data %>%
    # まず選択の分布を確認
    mutate(
      choice_numeric = as.integer(player.choice == "Y"),
      π_D = as.numeric(player.payoff_dictator),
      π_R = as.numeric(player.payoff_receiver),
      s = as.integer(π_R > π_D),  # 不利な不平等指標
      r = as.integer(π_D > π_R)   # 有利な不平等指標
    ) %>%
    filter(s != r) %>%  # 同値の場合を除外
    select(
      participant.id_in_session, 
      condition, 
      date, 
      subsession.round_number,  # ラウンド情報を追加
      player.choice,            # 元の選択も保持
      choice_numeric, 
      π_D, 
      π_R, 
      s, 
      r
    )
}

# データの前処理
processed_data <- prepare_social_preference_data(raw_data)

# 処理済みデータの詳細確認
print("選択の分布（元の選択）:")
table(processed_data$player.choice)

print("\n選択の分布（数値変換後）:")
table(processed_data$choice_numeric)

print("\n条件ごとの選択の分布:")
with(processed_data, table(condition, player.choice))

print("\nラウンドごとの選択の分布:")
with(processed_data, table(subsession.round_number, player.choice))

print("\n利得の要約統計:")
summary(processed_data[c("π_D", "π_R")])

print("\n不平等指標の分布:")
table(processed_data$s, processed_data$r)

# 処理済みデータの確認
glimpse(processed_data)
summary(processed_data)
# データの前処理後の確認
print(paste("処理済みデータの行数:", nrow(processed_data)))
print(paste("AI条件のデータ数:", nrow(filter(processed_data, condition == "AI"))))
print(paste("Control条件のデータ数:", nrow(filter(processed_data, condition == "Control"))))
```

# 社会的選好パラメータの推定

```{r parameter_estimation}
# 効用関数の定義
# u_D(π_D, π_R) = (1 - αs - βr)π_D + (αs + βr)π_R

# 尤度関数の定義
loglik_social_preference <- function(params, data) {
  α <- params[1]
  β <- params[2]
  
  # 効用差の計算
  utility_diff <- with(data, {
    u_X <- (1 - α * s - β * r) * π_D + (α * s + β * r) * π_R
    u_Y <- (1 - α * s - β * r) * π_R + (α * s + β * r) * π_D
    u_Y - u_X
  })
  
  # ロジット確率の計算
  prob <- 1 / (1 + exp(-utility_diff))
  
  # 対数尤度の計算
  loglik <- sum(data$choice_numeric * log(prob) + (1 - data$choice_numeric) * log(1 - prob))
  
  return(loglik)
}

# パラメータ推定（条件ごと）
estimate_parameters <- function(data, condition_name) {
  tryCatch({
    # 初期値を複数試す
    start_values <- list(
      c(α = 0.3, β = 0.2),
      c(α = 0.1, β = 0.1),
      c(α = 0.5, β = 0.5),
      c(α = 0.7, β = 0.3),
      c(α = 0.2, β = 0.4)
    )
    
    # 各初期値で推定を試みる
    results <- lapply(start_values, function(start) {
      tryCatch({
        maxLik(
          logLik = loglik_social_preference,
          start = start,
          method = "BFGS",
          data = data
        )
      }, error = function(e) NULL)
    })
    
    # 収束した結果の中から最も尤度の高いものを選択
    valid_results <- results[!sapply(results, is.null)]
    if (length(valid_results) == 0) {
      warning("すべての初期値で推定に失敗しました")
      return(NULL)
    }
    
    log_likes <- sapply(valid_results, function(x) x$maximum)
    result <- valid_results[[which.max(log_likes)]]
    
    # 結果の取得
    estimates <- coef(result)
    se <- sqrt(diag(vcov(result)))
    
    # 結果の整理
    tibble(
      condition = rep(condition_name, 2),
      parameter = c("α", "β"),
      estimate = as.numeric(estimates),
      std_error = as.numeric(se),
      z_value = estimate / std_error,
      p_value = 2 * (1 - pnorm(abs(z_value))),
      log_likelihood = result$maximum
    )
  }, error = function(e) {
    warning(paste("推定エラー:", e$message))
    return(NULL)
  })
}

# AI条件とコントロール条件それぞれで推定
results_AI <- estimate_parameters(
  filter(processed_data, condition == "AI"),
  "AI"
)

results_Control <- estimate_parameters(
  filter(processed_data, condition == "Control"),
  "Control"
)

# 結果の表示（NULLチェックを追加）
if (!is.null(results_AI) && !is.null(results_Control)) {
  bind_rows(results_AI, results_Control) %>%
    knitr::kable(digits = 3)
} else {
  cat("パラメータの推定に失敗しました。データを確認してください。")
}
```

# 結果の可視化

```{r visualization}
# パラメータ推定値の可視化
bind_rows(results_AI, results_Control) %>%
  ggplot(aes(x = parameter, y = estimate, fill = condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(
    aes(ymin = estimate - 1.96 * std_error,
        ymax = estimate + 1.96 * std_error),
    position = position_dodge(0.9),
    width = 0.25
  ) +
  labs(
    title = "社会的選好パラメータの推定結果",
    x = "パラメータ",
    y = "推定値",
    fill = "条件"
  ) +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2")
```

# 考察

推定された社会的選好パラメータ（α, β）の解釈：

- α > 0: 不利な不平等回避の程度
- β > 0: 有利な不平等回避の程度
- α = β = 0: 純粋な利己的選好
- α = β > 0: 効率性重視の利他的選好

条件間の比較から、以下のような考察が可能です：

1. パラメータの大きさの比較
2. 標準誤差の評価
3. 条件間の差の統計的有意性

これらの結果は、AI条件とコントロール条件における参加者の社会的選好の違いを示唆しています。
